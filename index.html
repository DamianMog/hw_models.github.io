<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modele na sprzedaż</title>
  
  <style>
    /* Podstawowe style/reset */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    /* Zapobieganie zaznaczaniu elementów */
    tr, img {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Tabela z listą modeli */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      /* Pozwala zawijać tekst */
      white-space: normal;
      vertical-align: middle;
    }
    th {
      background-color: #f4f4f4;
    }

    tr.selected {
      background-color: #caf0f8;
    }

    /* Checkbox powiększony */
    input[type="checkbox"] {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* Styl inputa liczbowego (Ilość) */
    input[type="number"] {
      width: 60px;
      text-align: center;
      padding: 2px 4px;
    }

    /* Kontener dla podsumowania i przycisku "Kopiuj". */
    #summary-container {
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #summary {
      font-size: 1em;
      max-width: 700px;
    }

    /* Przycisk "Kopiuj" */
    #copyBtn {
      display: none;  /* Pojawi się, gdy cokolwiek zostanie zaznaczone */
      padding: 8px 16px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    #copyBtn:hover {
      background-color: #0056b3;
    }

    .model-photo {
      max-width: 80px;
      max-height: 80px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Lista modeli na sprzedaż</h1>

  <!-- Kontener na tabelę z danymi -->
  <div id="table-container">
    <p>Wczytywanie danych...</p>
  </div>

  <!-- Kontener z przyciskiem kopiowania i podsumowaniem -->
  <div id="summary-container">
    <button id="copyBtn" onclick="copySummary()">Kopiuj</button>
    <div id="summary">
      Zaznacz wiersze z modelami, wybierz ilość i prześlij wiadomość do sprzedawcy.
    </div>
  </div>

  <script>
    /************************************************************
     * KONFIGURACJA
     ************************************************************/
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTntplgD3H3MoafVFReoBHcC_p2gYC7zYsqbuKbBncSDAg4YLG92e72QVdvwWvx6JDZHosRtS-uD144/pub?gid=1713753991&single=true&output=csv';

    // Kolumna Sell (index 10) musi być "Tak"
    const COLUMN_SELL = 10;

    // Kolumny z CSV, które wypełniamy w tabeli:
    // [Series (0), Year (1), Toy# (3), Col.# (4), Casting (5), Set# (7), Price (11), szt (12)]
    // W finalnej tabeli dojdą jeszcze: Photo1, Photo2, Wybierz, Ilość
    const HEADERS = [
      'Series', 'Year', 'Toy #', 'Col. #', 'Casting', 'Set #', 'Price', 'szt',
      'Photo 1', 'Photo 2', 'Wybierz', 'Ilość'
    ];
    const COLUMNS_FROM_CSV = [0, 1, 3, 4, 5, 7, 11, 12]; // 8 kolumn

    // Mapa (toyId -> {photo1, photo2})
    const imagesMap = {};

    function parseIntOr(val, def = 1) {
      const num = parseInt(val, 10);
      return isNaN(num) ? def : num;
    }

    /************************************************************
     * POBIERANIE LISTY PLIKÓW Z GITHUB
     ************************************************************/
    const repoOwner = "DamianMog";
    const repoName = "missing-cars.github.io";
    const folderPath = "images"; // Twój folder z plikami
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folderPath}`;

    // Najpierw pobierz listę plików z GitHuba, zapełnij imagesMap, potem pobierz CSV
    fetch(apiUrl)
      .then(resp => {
        if (!resp.ok) throw new Error(`Błąd GitHub API: ${resp.status}`);
        return resp.json();
      })
      .then(files => {
        // Parsujemy pliki:
        let validCount = 0;
        files.forEach(file => {
          if (file.type === "file" && file.name.match(/\.(jpg|jpeg|png|gif)$/i)) {
            // Odcinamy rozszerzenie:
            const nameNoExt = file.name.replace(/\.(jpg|jpeg|png|gif)$/i, ""); 
            const parts = nameNoExt.split("_"); // np. "HTC83_1" => ["HTC83","1"]
            if (parts.length === 2) {
              const [toyIdRaw, seq] = parts;
              // Usunięcie ew. spacji w toyId
              const toyId = toyIdRaw.trim();

              if ((seq === "1" || seq === "2") && toyId) {
                // Dodaj do imagesMap
                if (!imagesMap[toyId]) {
                  imagesMap[toyId] = { photo1: null, photo2: null };
                }
                if (seq === "1") imagesMap[toyId].photo1 = file.download_url;
                if (seq === "2") imagesMap[toyId].photo2 = file.download_url;
                validCount++;
              }
            }
          }
        });
        console.log('[DEBUG] Pobrano pliki z GitHub. Liczba dopasowanych zdjęć:', validCount);
        console.log('[DEBUG] imagesMap =', imagesMap);

        // Po wypełnieniu imagesMap pobieramy CSV i budujemy tabelę
        fetchAndBuildTable();
      })
      .catch(err => {
        console.error("Błąd podczas pobierania plików z GitHub:", err);
        // Nawet jeśli wystąpił błąd, spróbujmy pobrać sam CSV (będzie bez zdjęć)
        fetchAndBuildTable();
      });

    /************************************************************
     * POBIERANIE CSV + BUDOWA TABELI
     ************************************************************/
    function fetchAndBuildTable() {
      fetch(csvUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Błąd sieci (CSV): ${response.status}`);
          }
          return response.text();
        })
        .then(csvData => {
          // 1) Dzielenie na linie, usunięcie pustych
          const lines = csvData
            .split('\n')
            .map(line => line.trim())
            .filter(line => line !== '');

          // 2) Każda linia -> tablica kolumn
          const allRows = lines.map(line => line.split(','));
          if (allRows.length < 2) {
            throw new Error('CSV: brak danych lub za mało wierszy.');
          }

          // Pierwszy wiersz (allRows[0]) to oryginalne headery — pomijamy
          // Reszta to dane
          const bodyRows = allRows.slice(1);

          // 3) FILTR: Tylko wiersze, gdzie Sell (index 10) == "Tak"
          const filteredRows = bodyRows.filter(row => {
            const sellVal = (row[COLUMN_SELL] || '').trim().toLowerCase();
            return sellVal === 'tak';
          });

          console.log('[DEBUG] Liczba wierszy po filtrze Sell="Tak":', filteredRows.length);

          // 4) Budowa tabeli
          buildTable(filteredRows);
        })
        .catch(err => {
          console.error('Błąd podczas wczytywania CSV:', err);
          document.getElementById('table-container').innerHTML =
            '<p>Wystąpił błąd podczas wczytywania danych.</p>';
        });
    }

    function buildTable(filteredRows) {
      const table = document.createElement('table');

      // THEAD
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      HEADERS.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // TBODY
      const tbody = document.createElement('tbody');

      filteredRows.forEach((row, idx) => {
        const tr = document.createElement('tr');

        // 8 kolumn z CSV
        COLUMNS_FROM_CSV.forEach((colIndex, i) => {
          const td = document.createElement('td');
          td.textContent = row[colIndex]?.trim() || '';
          tr.appendChild(td);
        });

        // Odczyt toyId z CSV -> to kolumna 3 (Toy #)
        // ale w finalnej tabeli to będzie 2. kolumna (0=Series,1=Year,2=Toy#,3=Col#,...)
        const toyIdRaw = row[3]?.trim() || '';
        console.log(`[DEBUG] Wiersz #${idx}, toyIdRaw=${toyIdRaw}`); // Podgląd w konsoli

        // 9-ta kolumna => Photo 1
        const tdPhoto1 = document.createElement('td');
        if (toyIdRaw && imagesMap[toyIdRaw]?.photo1) {
          const img1 = document.createElement('img');
          img1.src = imagesMap[toyIdRaw].photo1;
          img1.classList.add('model-photo');
          tdPhoto1.appendChild(img1);
        }
        tr.appendChild(tdPhoto1);

        // 10-ta kolumna => Photo 2
        const tdPhoto2 = document.createElement('td');
        if (toyIdRaw && imagesMap[toyIdRaw]?.photo2) {
          const img2 = document.createElement('img');
          img2.src = imagesMap[toyIdRaw].photo2;
          img2.classList.add('model-photo');
          tdPhoto2.appendChild(img2);
        }
        tr.appendChild(tdPhoto2);

        // 11-ta kolumna => Wybierz (checkbox)
        const tdSelect = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.addEventListener('change', updateSummary);
        tdSelect.appendChild(checkbox);
        tr.appendChild(tdSelect);

        // 12-ta kolumna => Ilość (input number)
        const tdQty = document.createElement('td');
        const inputNumber = document.createElement('input');
        inputNumber.type = 'number';
        inputNumber.min = '1';
        // Kolumna 12 w CSV = 'szt'
        const sztValue = parseIntOr(row[12], 1);
        inputNumber.max = sztValue.toString();
        inputNumber.value = '1';
        inputNumber.addEventListener('change', updateSummary);
        tdQty.appendChild(inputNumber);
        tr.appendChild(tdQty);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      // Wstawienie do #table-container
      const container = document.getElementById('table-container');
      container.innerHTML = '';
      container.appendChild(table);

      // Na koniec odśwież podsumowanie (gdy nic nie jest zaznaczone)
      updateSummary();
    }

    /************************************************************
     * PODSUMOWANIE I KOPIOWANIE
     ************************************************************/
    function updateSummary() {
      const table = document.querySelector('#table-container table');
      if (!table) return;

      const rows = table.querySelectorAll('tbody tr');
      let totalCost = 0;
      let selectedCount = 0;
      const selectedModels = [];

      rows.forEach(row => {
        // Indeksy w finalnej tabeli:
        // 0:Series,1:Year,2:Toy#,3:Col.#,4:Casting,5:Set#,6:Price,7:szt,
        // 8:Photo1,9:Photo2,10:Wybierz,11:Ilość
        const checkboxCell = row.cells[10];
        const checkbox = checkboxCell.querySelector('input[type="checkbox"]');
        if (!checkbox) return;

        if (checkbox.checked) {
          selectedCount++;
          row.classList.add('selected');

          // Toy # => index 2
          const toyText = row.cells[2].textContent.trim();

          // Price => index 6
          const priceValue = parseFloat(row.cells[6].textContent) || 0;

          // Ilość => index 11
          const qtyInput = row.cells[11].querySelector('input[type="number"]');
          const qty = parseInt(qtyInput.value, 10) || 1;

          const cost = priceValue * qty;
          totalCost += cost;

          // Dodaj do listy
          selectedModels.push(`${toyText} (x${qty}, ${cost}zł)`);
        } else {
          row.classList.remove('selected');
        }
      });

      const summaryEl = document.getElementById('summary');
      const copyBtn = document.getElementById('copyBtn');

      if (selectedCount === 0) {
        summaryEl.textContent =
          'Zaznacz wiersze z modelami, wybierz ilość i prześlij wiadomość do sprzedawcy.';
        copyBtn.style.display = 'none';
        return;
      }

      copyBtn.style.display = 'inline-block';
      const joinedModels = selectedModels.join(', ');
      summaryEl.textContent =
        `Wybrano ${selectedCount} model(i).\n` +
        `Szczegóły: ${joinedModels}.\n` +
        `Razem do zapłaty: ${totalCost.toFixed(2)} zł.`;
    }

    function copySummary() {
      const summaryText = document.getElementById('summary').textContent;
      navigator.clipboard.writeText(summaryText).then(() => {
        alert('Skopiowano treść podsumowania!');
      });
    }
  </script>
</body>
</html>
