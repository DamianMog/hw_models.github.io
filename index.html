<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modele na sprzedaż</title>
  
  <style>
    /* Podstawowe style/reset */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    /* Zapobieganie zaznaczaniu elementów */
    tr, img {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Tabela z listą modeli */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      /* Pozwala zawijać tekst */
      white-space: normal;
    }
    th {
      background-color: #f4f4f4;
    }

    /* Wyróżnienie wiersza wybranego (jeśli chcesz podkreślać) */
    tr.selected {
      background-color: #caf0f8;
    }

    /* Powiększamy checkbox i ustawiamy kursory */
    input[type="checkbox"] {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* Styl inputa liczbowego (Ilość) */
    input[type="number"] {
      width: 60px;
      text-align: center;
      padding: 2px 4px;
    }

    /*
     * Kontener dla podsumowania i przycisku "Kopiuj".
     */
    #summary-container {
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #summary {
      font-size: 1em;
      max-width: 700px;
    }

    /* Przycisk "Kopiuj" */
    #copyBtn {
      display: none;  /* Pokażemy go dopiero, gdy cokolwiek zostanie zaznaczone */
      padding: 8px 16px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    #copyBtn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <h1>Lista modeli na sprzedaż</h1>

  <!-- Kontener na tabelę z danymi -->
  <div id="table-container">
    <p>Wczytywanie danych...</p>
  </div>

  <!-- Kontener z przyciskiem kopiowania i podsumowaniem -->
  <div id="summary-container">
    <button id="copyBtn" onclick="copySummary()">Kopiuj</button>
    <div id="summary">
      Zaznacz wiersze z modelami, wybierz ilość i prześlij wiadomość do sprzedawcy.
    </div>
  </div>

  <script>
    /************************************************************
     * KONFIGURACJA KOLUMN
     ************************************************************/
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTntplgD3H3MoafVFReoBHcC_p2gYC7zYsqbuKbBncSDAg4YLG92e72QVdvwWvx6JDZHosRtS-uD144/pub?gid=1713753991&single=true&output=csv';

    // Kolumna Sell (index 10) musi być "Tak"
    const COLUMN_SELL = 10;

    // Kolumny do wyświetlenia (bez NOTES (6)):
    // [Series (0), Year (1), Toy# (3), Col.# (4), Casting (5), Set# (7), Price (11), szt (12)]
    const COLUMNS_TO_SHOW = [0, 1, 3, 4, 5, 7, 11, 12];

    // Odpowiednie nazwy w thead
    const HEADERS = [
      'Series',
      'Year',
      'Toy #',
      'Col. #',
      'Casting',
      'Set #',
      'Price',
      'szt'
    ];

    // Funkcja do parsowania integera z fallbackiem
    function parseIntOr(val, def = 1) {
      const num = parseInt(val, 10);
      return isNaN(num) ? def : num;
    }

    /************************************************************
     * TWORZENIE TABELI + POBIERANIE DANYCH
     ************************************************************/
    fetch(csvUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Błąd sieci: ${response.status}`);
        }
        return response.text();
      })
      .then(csvData => {
        // 1) Dzielenie na linie, usunięcie pustych
        const lines = csvData
          .split('\n')
          .map(line => line.trim())
          .filter(line => line !== '');

        // 2) Każda linia -> tablica kolumn
        const allRows = lines.map(line => line.split(','));
        if (allRows.length < 2) {
          throw new Error('CSV: brak danych lub za mało wierszy.');
        }

        // Pierwszy wiersz (allRows[0]) to oryginalne headery — pomijamy
        // Reszta to dane
        const bodyRows = allRows.slice(1);

        // 3) FILTR: Tylko wiersze, gdzie Sell (index 10) == "Tak"
        const filteredRows = bodyRows.filter(row => {
          const sellVal = (row[COLUMN_SELL] || '').trim().toLowerCase();
          return sellVal === 'tak';
        });

        // 4) Budowa tabeli
        const table = document.createElement('table');

        // THEAD
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        // Dodajemy kolumny wg HEADERS
        HEADERS.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          headerRow.appendChild(th);
        });

        // Dodatkowe 2 kolumny: Wybierz, Ilość
        const thSelect = document.createElement('th');
        thSelect.textContent = 'Wybierz';
        headerRow.appendChild(thSelect);

        const thQty = document.createElement('th');
        thQty.textContent = 'Ilość';
        headerRow.appendChild(thQty);

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // TBODY
        const tbody = document.createElement('tbody');

        filteredRows.forEach(row => {
          const tr = document.createElement('tr');

          // Wypełniamy kolumny z COLUMNS_TO_SHOW
          COLUMNS_TO_SHOW.forEach(index => {
            const td = document.createElement('td');
            td.textContent = row[index] || '';
            tr.appendChild(td);
          });

          // Kolumna "Wybierz" (checkbox)
          const tdSelect = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          // Po kliknięciu => aktualizujemy podsumowanie
          checkbox.addEventListener('change', updateSummary);
          tdSelect.appendChild(checkbox);
          tr.appendChild(tdSelect);

          // Kolumna "Ilość" (input number)
          const tdQty = document.createElement('td');
          const inputNumber = document.createElement('input');
          inputNumber.type = 'number';
          inputNumber.min = '1';
          // max = wartość w kolumnie 'szt' (index = 12) lub 1
          const sztValue = parseIntOr(row[12], 1);
          inputNumber.max = sztValue.toString();
          inputNumber.value = '1';
          // Po zmianie ilości => aktualizujemy podsumowanie
          inputNumber.addEventListener('change', updateSummary);

          tdQty.appendChild(inputNumber);
          tr.appendChild(tdQty);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);

        // 5) Wstawienie tabeli do strony
        const container = document.getElementById('table-container');
        container.innerHTML = '';  // czyścimy stary tekst
        container.appendChild(table);

        // Początkowe wyświetlenie (jeśli nic nie zaznaczone)
        updateSummary();
      })
      .catch(err => {
        console.error('Błąd podczas wczytywania CSV:', err);
        document.getElementById('table-container').innerHTML =
          '<p>Wystąpił błąd podczas wczytywania danych.</p>';
      });

    /************************************************************
     * OBSŁUGA PODSUMOWANIA I KOPIOWANIA
     ************************************************************/
    function updateSummary() {
      const table = document.querySelector('#table-container table');
      if (!table) return;

      const rows = table.querySelectorAll('tbody tr');
      let totalCost = 0;
      let selectedCount = 0;

      // Tablica na szczegóły wybranych modeli
      const selectedModels = [];

      rows.forEach(row => {
        // Finalna tabela (po kolumnach COLUMNS_TO_SHOW) ma:
        //   0: Series
        //   1: Year
        //   2: Toy #
        //   3: Col. #
        //   4: Casting
        //   5: Set #
        //   6: Price
        //   7: szt
        //   8: Wybierz (checkbox)
        //   9: Ilość (input)
        const checkboxCell = row.cells[8];
        const checkbox = checkboxCell.querySelector('input[type="checkbox"]');
        if (!checkbox) return; // Bez checkboxa omijamy

        if (checkbox.checked) {
          selectedCount++;
          row.classList.add('selected'); // Podświetlenie wiersza

          // Odczyt Toy #
          const toyText = row.cells[2].textContent; 

          // Odczyt ceny (Price) → komórka 6
          const priceCell = row.cells[6];
          const priceValue = parseFloat(priceCell.textContent) || 0;

          // Ilość → komórka 9
          const qtyCell = row.cells[9];
          const qtyInput = qtyCell.querySelector('input[type="number"]');
          const qty = parseInt(qtyInput.value, 10) || 1;

          // Koszt = cena * ilość
          const cost = priceValue * qty;
          totalCost += cost;

          // Dodajemy do listy wybranych modeli: np. "Batmobile (x5, 50zł)"
          selectedModels.push(`${toyText} (x${qty}, ${cost}zł)`);
        } else {
          row.classList.remove('selected');
        }
      });

      const summaryEl = document.getElementById('summary');
      const copyBtn = document.getElementById('copyBtn');

      if (selectedCount === 0) {
        summaryEl.textContent =
          'Zaznacz wiersze z modelami, wybierz ilość i prześlij wiadomość do sprzedawcy.';
        copyBtn.style.display = 'none';
        return;
      }

      // Jeśli zaznaczono cokolwiek → pokazujemy przycisk kopiowania
      copyBtn.style.display = 'inline-block';

      // Budowa treści podsumowania:
      // "Wybrano 2 modele. Szczegóły: Batmobile (x5, 50zł), Tumbler (x2, 40zł). Razem do zapłaty: 90.00 zł."
      const joinedModels = selectedModels.join(', ');
      summaryEl.textContent =
        `Wybrano ${selectedCount} model(i).\n` +
        `Szczegóły: ${joinedModels}.\n` +
        `Razem do zapłaty: ${totalCost.toFixed(2)} zł.`;
    }

    function copySummary() {
      const summaryText = document.getElementById('summary').textContent;
      navigator.clipboard.writeText(summaryText).then(() => {
        alert('Skopiowano treść podsumowania!');
      });
    }
  </script>
</body>
</html>
