<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista modeli, które chcę kupić</title>
  
  <style>
    /* Podstawowe style/reset */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    /* Kontener górny na przycisk powrotu */
    #back-button-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    #back-button {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      background-color: #f4f4f4;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      text-decoration: none;
      color: #333;
      font-size: 1em;
    }
    #back-button:hover {
      background-color: #e0e0e0;
    }
    /* Ikonka/strzałka w lewo */
    .arrow-left {
      margin-right: 8px;
      font-weight: bold;
    }

    /* Zapobieganie zaznaczaniu elementów */
    tr, img {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* Włączenie zaznaczania tekstu w kolumnie "Toy #" */
    table th:nth-child(4),
    table td:nth-child(4) {
      user-select: text;
    }

    /* Tabela z listą modeli */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      /* Pozwala zawijać tekst */
      white-space: normal;
      vertical-align: middle;
    }
    th {
      background-color: #f4f4f4;
    }

    /* Wyróżnienie wiersza wybranego */
    tr.selected {
      background-color: #caf0f8;
    }

    /* Powiększamy checkbox i ustawiamy kursory */
    input[type="checkbox"] {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* Styl inputa liczbowego (Ilość) */
    input[type="number"] {
      width: 60px;
      text-align: center;
      padding: 2px 4px;
    }

    /*
     * Kontener dla podsumowania i przycisku "Kopiuj".
     */
    #summary-container {
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #summary {
      font-size: 1em;
      max-width: 700px;
    }

    /* Przycisk "Kopiuj" */
    #copyBtn {
      display: none;  /* Pokażemy go dopiero, gdy cokolwiek zostanie zaznaczone */
      padding: 8px 16px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      background-color: #007BFF;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    #copyBtn:hover {
      background-color: #0056b3;
    }

    /* Styl zdjęć w tabeli */
    .model-photo {
      max-width: 80px;
      max-height: 80px;
      cursor: pointer; /* miniatura jest klikalna */
    }

    /* ======= POPUP Z OBRAZKIEM ======= */
    #image-popup {
      display: none; /* ukryte domyślnie */
      position: fixed;
      top: 0; left: 0; 
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8); 
      justify-content: center; 
      align-items: center;
      z-index: 2000; /* powyżej innych elementów na stronie */
    }
    #image-popup img {
      max-width: 90%;
      max-height: 90%;
      cursor: pointer;
    }
    #image-popup .close-button {
      position: absolute;
      top: 20px; right: 30px;
      color: #fff;
      font-size: 32px;
      cursor: pointer;
      user-select: none;
    }
  </style>
</head>
<body>

  <!-- Przycisk powrotu -->
  <div id="back-button-container">
    <button id="back-button" onclick="window.location.href='../index.html'">
      <span class="arrow-left">←</span>
      Powrót
    </button>
  </div>

  <h1>Lista modeli, które chcę kupić</h1>
  <h3>Jeżeli posiadasz na sprzedaż model z poniższej listy, możesz go zaznaczyć, a następnie skopiować podsumowanie które znajduje się pod tabelą. Prześlij takie podsumowanie do mnie w celu sfinalizowania zakupu.</h3>
  
  <!-- Kontener na tabelę z danymi -->
  <div id="table-container">
    <p>Wczytywanie danych...</p>
  </div>

  <!-- Kontener z przyciskiem kopiowania i podsumowaniem -->
  <div id="summary-container">
    <button id="copyBtn" onclick="copySummary()">Kopiuj</button>
    <div id="summary">
      Zaznacz wiersze z modelami, wybierz ilość i prześlij wiadomość do sprzedawcy.
    </div>
  </div>

  <!-- ====== POPUP DO POWIĘKSZANIA ZDJĘĆ ===== -->
  <div id="image-popup">
    <span class="close-button" id="popup-close">&times;</span>
    <img id="popup-image" src="" alt="Photo fullscreen" />
  </div>

  <script>
    /************************************************************
     * KONFIGURACJA KOLUMN
     ************************************************************/
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTntplgD3H3MoafVFReoBHcC_p2gYC7zYsqbuKbBncSDAg4YLG92e72QVdvwWvx6JDZHosRtS-uD144/pub?gid=1713753991&single=true&output=csv';

    // Nazwy nagłówków dla buy.html
    const HEADERS = [
      'Series',
      'Year',
      'Toy #',
      'Casting',
      'Set #',
      'Photo',
      'Posiadam'
    ];

    // Kolumny z CSV do wypełnienia (Series, Year, Toy #, Casting, Set #)
    // Zakładam, że Series = 0, Year =1, Toy #=3, Casting=4, Set #=5
    // Dostosuj indeksy zgodnie z rzeczywistą strukturą CSV
    const COLUMNS_FROM_CSV = [0, 1, 3, 4, 5];

    // Indeks kolumny "In Collection" (zero-based index)
    const IN_COLLECTION_INDEX = 2; // Zmieniono z 7 na 2

    // Mapa toyId -> { photo }
    const imagesMap = {};

    /************************************************************
     * KONFIGURACJA POBIERANIA OBRAZKÓW Z GITHUB
     ************************************************************/
    const repoOwner = "DamianMog";
    const repoName = "hw_models.github.io";
    // Ścieżka do folderu buy/images
    const folderPath = "buy/images";  
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folderPath}`;

    // Najpierw pobieramy listę plików z GitHuba,
    // by stworzyć imagesMap (toyId => photo)
    fetch(apiUrl)
      .then(resp => {
        if (!resp.ok) throw new Error(`Błąd GitHub API: ${resp.status}`);
        return resp.json();
      })
      .then(files => {
        // Usunięto wszystkie istniejące wiadomości debugujące

        files.forEach(file => {
          if (file.type === "file" && file.name.match(/\.(jpg|jpeg|png|gif|webp|jfif)$/i)) { // Dodano webp i jfif
            const nameNoExt = file.name.replace(/\.(jpg|jpeg|png|gif|webp|jfif)$/i, ""); // Dodano webp i jfif
            const toyId = nameNoExt.replace(/\./g, '').trim(); // usunięcie kropek i trim

            if (toyId) {
              imagesMap[toyId] = file.download_url;
            }
          }
        });

        fetchAndBuildTable();
      })
      .catch(err => {
        console.error("Błąd podczas pobierania plików z GitHub:", err);
        fetchAndBuildTable(); // Mimo błędu spróbujemy wczytać CSV
      });

    /************************************************************
     * POBIERANIE CSV I BUDOWA TABELI
     ************************************************************/
    function fetchAndBuildTable() {
      fetch(csvUrl)
        .then(response => {
          if (!response.ok) throw new Error(`Błąd sieci (CSV): ${response.status}`);
          return response.text();
        })
        .then(csvData => {
          const lines = csvData
            .split('\n')
            .map(line => line.trim())
            .filter(line => line !== '');

          if (lines.length === 0) {
            throw new Error('CSV jest pusty.');
          }

          const headerLine = lines[0];
          const headers = headerLine.split(',').map(header => header.trim());
          // console.log("Nagłówki z pliku CSV:", headers);

          // Logowanie kolejności nagłówków
          headers.forEach((header, index) => {
            // console.log(`Indeks ${index}: ${header}`);
          });

          // Sprawdzenie, czy nagłówek "In Collection" istnieje
          if (!headers.includes('In Collection')) {
            // console.warn('Kolumna "In Collection" nie została znaleziona w nagłówkach CSV.');
          }

          const allRows = lines.slice(1).map(line => line.split(','));
          if (allRows.length < 1) {
            throw new Error('CSV: brak danych lub za mało wierszy.');
          }

          const bodyRows = allRows;

          // Logowanie informacji do konsoli
          const totalRows = bodyRows.length;
          // console.log("Łączna liczba wierszy w CSV:", totalRows);

          const rowsWithYear2023 = bodyRows.filter(row => row[1] && row[1].trim() === '2023').length;
          // console.log("Liczba wierszy gdzie Year == 2023:", rowsWithYear2023);

          const rowsWithYear2024 = bodyRows.filter(row => row[1] && row[1].trim() === '2024').length;
          // console.log("Liczba wierszy gdzie Year == 2024:", rowsWithYear2024);

          const rowsWithYear2025 = bodyRows.filter(row => row[1] && row[1].trim() === '2025').length;
          // console.log("Liczba wierszy gdzie Year == 2025:", rowsWithYear2025);

          const rowsWithYearPremium = bodyRows.filter(row => row[1] && row[1].trim().toLowerCase() === 'premium').length;
          // console.log("Liczba wierszy gdzie Year == Premium:", rowsWithYearPremium);

          const rowsWithInNie = bodyRows.filter(row => row[IN_COLLECTION_INDEX] && row[IN_COLLECTION_INDEX].trim().toLowerCase() === 'nie').length;
          // console.log("Liczba wierszy gdzie In Collection == Nie:", rowsWithInNie);

          const rowsWithInTak = bodyRows.filter(row => row[IN_COLLECTION_INDEX] && row[IN_COLLECTION_INDEX].trim().toLowerCase() === 'tak').length;
          // console.log("Liczba wierszy gdzie In Collection == Tak:", rowsWithInTak);

          // Filtrowanie danych: Year == 2024, In Collection == Nie
          const filteredRows = bodyRows.filter(row => {
            const yearVal = (row[1] || '').trim(); // Year
            const inVal = (row[IN_COLLECTION_INDEX] || '').trim().toLowerCase(); // 'In Collection' jest kolumną IN_COLLECTION_INDEX

            return yearVal === '2024' && inVal === 'nie';
          });

          // console.log("Ilość wierszy po filtrze Year=2024, In Collection=Nie:", filteredRows.length);

          // Filtrowanie danych: Year == 2024, In Collection == Nie i Series != Red Edition
          const furtherFilteredRows = filteredRows.filter(row => {
            const seriesVal = (row[0] || '').trim();
            return seriesVal.toLowerCase() !== 'red edition';
          });

          // console.log("Ilość wierszy po filtrze Year=2024, In Collection=Nie i Series!=Red Edition:", furtherFilteredRows.length);

          /************************************************************
           * DODANIE FILTRACJI NA PODSTAWIE "In Collection"
           ************************************************************/
          // Filtrowanie bez "Exclusive"
          const withoutExclusive = furtherFilteredRows.filter(row => {
            const inCollection = row[IN_COLLECTION_INDEX] ? row[IN_COLLECTION_INDEX].trim() : '';
            return !inCollection.includes('Exclusive');
          });
          // console.log(`Ilość wierszy po filtrze Year=2024, In Collection=Nie, Series!=Red Edition, bez "Exclusive": ${withoutExclusive.length}`);

          // Filtrowanie bez "Super Treasure Hunt"
          const withoutSuperTreasureHunt = furtherFilteredRows.filter(row => {
            const inCollection = row[IN_COLLECTION_INDEX] ? row[IN_COLLECTION_INDEX].trim() : '';
            return !inCollection.includes('Super Treasure Hunt');
          });
          // console.log(`Ilość wierszy po filtrze Year=2024, In Collection=Nie, Series!=Red Edition, bez "Super Treasure Hunt": ${withoutSuperTreasureHunt.length}`);

          // Filtrowanie bez "Exclusive" i "Super Treasure Hunt"
          const withoutBoth = furtherFilteredRows.filter(row => {
            const inCollection = row[IN_COLLECTION_INDEX] ? row[IN_COLLECTION_INDEX].trim() : '';
            return !inCollection.includes('Exclusive') && !inCollection.includes('Super Treasure Hunt');
          });
          // console.log(`Ilość wierszy po filtrze Year=2024, In Collection=Nie, Series!=Red Edition, bez "Super Treasure Hunt" & "Exclusive": ${withoutBoth.length}`);

          // Ostateczne filtrowanie do wyświetlenia w tabeli
          const finalFilteredRows = withoutBoth;

          // Informacja o użytych nagłówkach do poszczególnych czynności
          // console.log("Użyte nagłówki do filtrowania:");
          // console.log(`- Year: ${headers[1]} (indeks 1)`);
          // console.log(`- In Collection: ${headers[IN_COLLECTION_INDEX]} (indeks ${IN_COLLECTION_INDEX})`);
          // console.log(`- Series: ${headers[0]} (indeks 0)`);

          buildTable(finalFilteredRows);
        }
        .catch(err => {
          console.error('Błąd podczas wczytywania CSV:', err);
          // Poprawiono przypisanie innerHTML na jednej linii, aby uniknąć błędu składniowego
          document.getElementById('table-container').innerHTML = '<p>Wystąpił błąd podczas wczytywania danych.</p>';
        });
    }

    function buildTable(filteredRows) {
      const table = document.createElement('table');

      // THEAD
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      HEADERS.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // TBODY
      const tbody = document.createElement('tbody');

      filteredRows.forEach(row => {
        const tr = document.createElement('tr');

        // Wypełnienie kolumn: Series, Year, Toy #, Casting, Set #
        COLUMNS_FROM_CSV.forEach((colIndex) => {
          const td = document.createElement('td');
          td.textContent = (row[colIndex] || '').trim();
          tr.appendChild(td);
        });

        // Odczyt toyId
        const toyId = (row[3] || '').trim(); // Toy # jest w kolumnie 3

        // Kolumna Photo
        const tdPhoto = document.createElement('td');
        tdPhoto.innerHTML = '';
        if (toyId && imagesMap[toyId]) {
          const img = document.createElement('img');
          img.classList.add('model-photo');
          img.src = imagesMap[toyId];
          img.alt = `Foto modelu ${toyId}`;
          // Kliknięcie w zdjęcie => fullscreen
          img.addEventListener('click', () => {
            showImagePopup(imagesMap[toyId]);
          });
          tdPhoto.appendChild(img);
        }
        tr.appendChild(tdPhoto);

        // Kolumna Posiadam (checkbox)
        const tdPosiadam = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            tr.classList.add('selected');
          } else {
            tr.classList.remove('selected');
          }
          updateSummary();
        });
        tdPosiadam.appendChild(checkbox);
        tr.appendChild(tdPosiadam);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      const container = document.getElementById('table-container');
      container.innerHTML = '';  
      container.appendChild(table);

      // Początkowa aktualizacja
      updateSummary();
    }

    /************************************************************
     * POPUP ZE ZDJĘCIEM (FULL SCREEN)
     ************************************************************/
    const imagePopup = document.getElementById('image-popup');
    const popupImage = document.getElementById('popup-image');
    const popupCloseBtn = document.getElementById('popup-close');

    // Kliknięcie w "X" zamyka popup
    popupCloseBtn.addEventListener('click', hideImagePopup);

    // Kliknięcie w tło lub sam obrazek -> zamyka popup
    imagePopup.addEventListener('click', hideImagePopup);

    // ESC zamyka popup
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideImagePopup();
      }
    });

    function showImagePopup(src) {
      popupImage.src = src;
      imagePopup.style.display = 'flex'; // widać overlay
    }
    function hideImagePopup() {
      imagePopup.style.display = 'none';
      popupImage.src = '';
    }

    /************************************************************
     * OBSŁUGA PODSUMOWANIA I KOPIOWANIA
     ************************************************************/
    function updateSummary() {
      const table = document.querySelector('#table-container table');
      if (!table) return;

      const rows = table.querySelectorAll('tbody tr');
      let selectedCount = 0;

      const selectedModels = [];

      rows.forEach(row => {
        // Indeksy w finalnej tabeli:
        // 0: Series
        // 1: Year
        // 2: Casting
        // 3: Set #
        // 4: Photo
        // 5: Posiadam (checkbox)
        const checkboxCell = row.cells[5];
        const checkbox = checkboxCell.querySelector('input[type="checkbox"]');
        if (!checkbox) return;

        if (checkbox.checked) {
          selectedCount++;

          const toyId = row.cells[2].textContent.trim(); // Toy # jest w kolumnie 2
          selectedModels.push(`${toyId}`);
        }
      });

      const summaryEl = document.getElementById('summary');
      const copyBtn = document.getElementById('copyBtn');

      if (selectedCount === 0) {
        summaryEl.textContent =
          'Zaznacz wiersze z modelami, wybierz ilość i prześlij wiadomość do sprzedawcy.';
        copyBtn.style.display = 'none';
        return;
      }

      copyBtn.style.display = 'inline-block';

      const joinedModels = selectedModels.join(', ');
      summaryEl.textContent =
        `Wybrano ${selectedCount} model(i).\n` +
        `Szczegóły: ${joinedModels}.`;
    }

    function copySummary() {
      const summaryText = document.getElementById('summary').textContent;
      navigator.clipboard.writeText(summaryText).then(() => {
        alert('Skopiowano treść podsumowania!');
      });
    }
  </script>
</body>
</html>
